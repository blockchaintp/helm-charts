{{$peering:= .Values.sawtooth.dynamicPeering}}

# Convert value to an int type so that the compare works
{{ $consensus := .Values.sawtooth.consensus | int }}
---
apiVersion: apps/v1
kind: {{ if eq $consensus 100 }}StatefulSet{{else}}DaemonSet{{end}}
metadata:
  name: {{.Values.sawtooth.networkName}}-validator
  labels: {{- include "lib.labels" . }}
spec:
  {{ if eq $consensus 100}}
  replicas: 1
  serviceName: {{.Values.sawtooth.networkName}}-validator
  {{ else }}
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: {{.Values.sawtooth.maxUnavailable}}
  minReadySeconds: {{.Values.sawtooth.minReadySeconds}}
  {{ end }}
  selector:
    matchLabels:
      app: {{.Values.sawtooth.networkName}}-validator
  template:
    metadata:
      labels:
        app: {{.Values.sawtooth.networkName}}-validator
    spec:
      serviceAccountName: {{.Values.sawtooth.networkName}}-sa
      automountServiceAccountToken: true
      {{if .Values.affinity.enabled}}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: app
                  operator: In
                  values:
                  - {{.Values.sawtooth.networkName}}-validator
      {{ else }}
      affinity: {{- include "lib.safeToYaml" .Values.sawtooth.affinity | nindent 8 }}
      {{ end }}
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
      hostAliases:
      {{ range .Values.sawtooth.externalSeeds }}
      - ip: {{.ip}}
        hostnames:
        - {{.hostname}}
      {{ end }}
      containers:
        {{ if eq $consensus 400 }}
        - name: pbft-engine
          image: {{.Values.images.pbft_engine}}
          imagePullPolicy: {{.Values.sawtooth.containers.pbft_engine.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              rm -f /var/lib/sawtooth/pbft.log
              pbft-engine {{.Values.sawtooth.containers.pbft_engine.args}} \
                -C tcp://127.0.0.1:{{ .Values.sawtooth.ports.consensus }} \
                --storage-location disk+/var/lib/sawtooth/pbft.log
          env:
            {{ range .Values.sawtooth.containers.pbft_engine.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/pbft-engine
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/pbft-engine ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.pbft_engine.resources | nindent 12 }}
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            - mountPath: "/var/lib/sawtooth"
              name: sawtooth-data
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        {{ else if eq $consensus 300 }}
        - name: raft-engine
          image: {{.Values.images.raft_engine}}
          imagePullPolicy: {{.Values.sawtooth.containers.raft_engine.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              raft-engine {{.Values.sawtooth.containers.raft_engine.args}} \
                -C tcp://127.0.0.1:{{.Values.sawtooth.ports.consensus}}
          env:
            {{ range .Values.sawtooth.containers.raft_engine.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/raft-engine
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/raft-engine ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.raft_engine.resources | nindent 12 }}
          volumeMounts:
            - mountPath: "/etc/sawtooth"
              name: sawtooth-etc
            - mountPath: "/var/lib/sawtooth"
              name: sawtooth-data
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        {{ else if eq $consensus 200 }}
        - name: poet-engine
          image: {{.Values.images.poet_engine}}
          imagePullPolicy: {{.Values.sawtooth.containers.poet_engine.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              poet-engine {{.Values.sawtooth.containers.poet_engine.args}} \
                --connect tcp://127.0.0.1:{{.Values.sawtooth.ports.consensus}} \
                --component tcp://127.0.0.1:{{.Values.sawtooth.ports.sawcomp}}
          env:
            {{ range .Values.sawtooth.containers.poet_engine.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/poet-engine
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/poet-engine ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          volumeMounts:
            - mountPath: "/etc/sawtooth"
              name: sawtooth-etc
            - mountPath: "/var/lib/sawtooth"
              name: sawtooth-data
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.poet_engine.resources | nindent 12 }}
        - name: poet-validator-registry-tp
          image: {{.Values.images.poet_validator_registry_tp}}
          imagePullPolicy: {{.Values.sawtooth.containers.poet_validator_registry_tp.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              poet-validator-registry-tp {{.Values.sawtooth.containers.poet_validator_registry_tp.args}} \
                -C tcp://127.0.0.1:{{.Values.sawtooth.ports.sawcomp}}
          env:
            {{ range .Values.sawtooth.containers.poet_validator_registry_tp.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/poet-validatory-registry-tp
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/poet-validator-registry-tp ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          volumeMounts:
            - mountPath: "/etc/sawtooth"
              name: sawtooth-etc
            - mountPath: "/var/lib/sawtooth"
              name: sawtooth-data
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.poet_validator_registry_tp.resources | nindent 12 }}
        {{ else }}
        - name: devmode-engine
          image: {{.Values.images.devmode_engine}}
          imagePullPolicy: {{.Values.sawtooth.containers.devmode_engine.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              devmode-engine-rust {{.Values.sawtooth.containers.devmode_engine.args}} \
                -C tcp://127.0.0.1:{{.Values.sawtooth.ports.consensus}}
          env:
            {{ range .Values.sawtooth.containers.devmode_engine.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/devmode-engine
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/devmode-engine ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.devmode_engine.resources | nindent 12 }}
        {{ end }}
        - name: settings-tp
          image: {{.Values.images.settings_tp}}
          imagePullPolicy: {{.Values.sawtooth.containers.settings_tp.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              settings-tp {{.Values.sawtooth.containers.settings_tp.args}} \
                --connect tcp://127.0.0.1:{{.Values.sawtooth.ports.sawcomp}}
          env:
            {{ range .Values.sawtooth.containers.settings_tp.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/settings-tp
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/settings-tp ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.settings_tp.resources | nindent 12 }}
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        - name: block-info-tp
          image: {{.Values.images.block_info_tp}}
          imagePullPolicy: {{.Values.sawtooth.containers.block_info.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              block-info-tp {{.Values.sawtooth.containers.block_info.args}} \
                -C tcp://127.0.0.1:{{.Values.sawtooth.ports.sawcomp}}
          env:
            {{ range .Values.sawtooth.containers.block_info.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/block-info-tp
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/block-info-tp ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.block_info.resources | nindent 12 }}
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        - name: intkey-tp
          image: {{.Values.images.intkey_tp}}
          imagePullPolicy: {{.Values.sawtooth.containers.intkey_tp.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              intkey-tp-go {{.Values.sawtooth.containers.intkey_tp.args}} \
                --connect tcp://127.0.0.1:{{.Values.sawtooth.ports.sawcomp}}
          env:
            {{ range .Values.sawtooth.containers.intkey_tp.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/intkey-tp
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/intkey-tp ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.intkey_tp.resources | nindent 12 }}
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        {{ if .Values.sawtooth.permissioned }}
        - name: identity-tp
          image: {{.Values.images.identity_tp}}
          imagePullPolicy: {{.Values.sawtooth.containers.identity_tp.imagePullPolicy}}
          command: [ "bash", "-c" ]
          args:
            - |
              identity-tp {{.Values.sawtooth.containers.identity_tp.args}} \
                -C tcp://127.0.0.1:{{.Values.sawtooth.ports.sawcomp}}
          env:
            {{ range .Values.sawtooth.containers.identity_tp.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/identity-tp
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/identity-tp ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.identity_tp.resources | nindent 12 }}
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        {{ end }}
        {{ if .Values.sawtooth.daml.enabled }}
        - name: daml-tp
          image: {{.Values.images.daml_tp}}
          imagePullPolicy: {{.Values.sawtooth.containers.daml_tp.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              /opt/sawtooth-daml-tp/entrypoint.sh {{.Values.sawtooth.containers.daml_tp.args}} \
                tcp://localhost:{{.Values.sawtooth.ports.sawcomp}}
          resources:
            limits: {}
            requests:
              cpu: "50m"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            {{ range .Values.sawtooth.containers.daml_tp.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/daml-tp
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/daml-tp ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.daml_tp.resources | nindent 12 }}
        - name: timekeeper
          {{- include "lib.image" (dict "imageRoot" .Values.timekeeper.image "global" $) | nindent 10}}
          command: [ "bash", "-c"]
          args:
            - |
              /opt/timekeeper/entrypoint.sh {{ .Values.timekeeper.args }} \
                -C tcp://localhost:{{ .Values.sawtooth.ports.sawcomp }} \
                --tp
          env: {{- include "lib.safeToYaml" .Values.timekeeper.env | nindent 8 }}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/timekeeper
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/timekeeper ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          resources: {{- include "lib.safeToYaml" .Values.timekeeper.resources | nindent 12 }}
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        {{ end }}
        {{range .Values.sawtooth.customTPs}}
        - name: {{.name}}
          image: {{.image}}
          {{if .command}}command: [ {{ range .command }}"{{.}}",{{end}} ]{{end}}
          {{if .args}}args: [ {{ range .args}}"{{.}}", {{end}} ]{{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/{{.name}}
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/{{.name}} ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
        {{end}}
        - name: rest-api
          image: {{.Values.images.rest_api}}
          imagePullPolicy: {{.Values.sawtooth.containers.rest_api.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
          - |
            sleep {{.Values.sawtooth.client_wait}}
            sawtooth-rest-api {{.Values.sawtooth.containers.rest_api.args}} \
              --bind 0.0.0.0:{{.Values.sawtooth.ports.rest}} \
              --connect tcp://127.0.0.1:{{.Values.sawtooth.ports.sawcomp}} \
          {{- if .Values.sawtooth.opentsdb.enabled }}
              --opentsdb-db {{.Values.sawtooth.opentsdb.db}} \
              --opentsdb-url {{ .Values.sawtooth.opentsdb.url}}
          {{- end }}
          ports:
            - containerPort: {{.Values.sawtooth.ports.rest}}
              name: sawrest
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            {{ range .Values.sawtooth.containers.rest_api.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    rm -f $SIGNALS_DIR/rest-api
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  SIGNALS_DIR=/var/run/sawtooth
                  if [ -r $SIGNALS_DIR/rest-api ]; then
                    exit 1
                  else
                    exit 0
                  fi
            failureThreshold: 1
            periodSeconds: 3
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.rest_api.resources | nindent 12 }}
        - name: monitor
          image: {{.Values.images.shell}}
          imagePullPolicy: {{.Values.sawtooth.containers.monitor.imagePullPolicy}}
          command: [ "bash", "-c"]
          args:
            - |
              sawtooth keygen && \
              sleep {{.Values.sawtooth.client_wait}} && \
              /usr/local/bin/heartbeat_loop.sh \
                http://127.0.0.1:{{.Values.sawtooth.ports.rest}} \
                test-$RANDOM {{.Values.sawtooth.heartbeat.interval}}
          volumeMounts:
            - mountPath: "/etc/sawtooth"
              name: sawtooth-etc
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.monitor.resources | nindent 12 }}
        - name: validator
          image: {{.Values.images.validator}}
          imagePullPolicy: {{.Values.sawtooth.containers.validator.imagePullPolicy}}
          lifecycle:
            preStop:
              exec:
                command:
                  - bash
                  - -c
                  - |
                    SIGNALS_DIR=/var/run/sawtooth
                    export EXIT_SIGNALS="{{.Values.sawtooth.livenessProbe.exitSignals}}"
                    for signal in ${EXIT_SIGNALS}; do
                      touch "${SIGNALS_DIR}/$signal"
                    done
            postStart:
              exec:
                command:
                  - bash
                  - -c
                  - |
                    RUN_DIR=/var/run/sawtooth
                    rm -f $RUN_DIR/probe.*
                    rm -f $RUN_DIR/catchup.started
                    rm -f $RUN_DIR/last*
                    rm -f $RUN_DIR/pbft_seq*
          command: ["bash", "-c" ]
          args:
            - |
              sleep 30
              source /usr/local/bin/validator_env.sh {{.Values.sawtooth.namespace}} \
                {{.Values.sawtooth.networkName}} ${POD_NAME} ${POD_IP} ${NODE_NAME} \
                {{.Values.sawtooth.ports.sawnet}}
              start_delay=$(( $DELAY * 5 ))
              sleep $start_delay
              if [ ! -r /etc/sawtooth/initialized ]; then
                if [ $RUN_GENESIS -eq 1 ]; then
            {{ if eq $consensus 400 }}
                  bash -x /usr/local/bin/pbft_genesis_config.sh {{.Values.sawtooth.namespace}}
            {{ else if eq $consensus 300 }}
                  bash -x /usr/local/bin/raft_genesis_config.sh {{.Values.sawtooth.namespace}}
            {{ else if eq $consensus 200 }}
                  bash -x /usr/local/bin/poet_genesis_config.sh {{.Values.sawtooth.namespace}}
            {{ else }}
                  bash -x /usr/local/bin/devmode_genesis_config.sh {{.Values.sawtooth.namespace}}
            {{ end }}
            {{ if .Values.sawtooth.permissioned }}
                  /usr/local/bin/identity_genesis_config.sh {{.Values.sawtooth.namespace}}
            {{ end }}
                  sawset genesis -k /etc/sawtooth/keys/validator.priv \
                    -o /etc/sawtooth/genesis/000-genesis.batch
                  cd /etc/sawtooth/genesis
                  sawadm genesis `ls |sort`
                  cd -
                fi
                touch /etc/sawtooth/initialized;
              fi
              if [ -r /var/lib/sawtooth/data.reset ]; then
                rm -rf /var/lib/sawtooth/*
              fi
              PEERS=$(echo $PEERS | sed -e 's/:8800/:{{.Values.sawtooth.ports.sawnet}}/g')
              SEEDS=$(echo $SEEDS | sed -e 's/:8800/:{{.Values.sawtooth.ports.sawnet}}/g')
              SIGNALS_DIR=/var/run/sawtooth
              export EXIT_SIGNALS="{{.Values.sawtooth.livenessProbe.exitSignals}}"
              for signal in ${EXIT_SIGNALS}; do
                while [ -r "$SIGNALS_DIR/$signal" ]; do
                  sleep 1
                done
              done
              find /var/lib/sawtooth -name '.atomicwrite.*' -exec rm -rf {}  \; -print
              sawtooth-validator {{.Values.sawtooth.containers.validator.args}} \
                --scheduler {{.Values.sawtooth.scheduler}} \
                --endpoint tcp://${NODE_NAME}:{{.Values.sawtooth.ports.sawnet}} \
                --bind component:tcp://0.0.0.0:{{.Values.sawtooth.ports.sawcomp}} \
                --bind consensus:tcp://0.0.0.0:{{.Values.sawtooth.ports.consensus}} \
                --bind network:tcp://0.0.0.0:{{.Values.sawtooth.ports.sawnet}} \
                --peering {{if ($peering)}}dynamic{{else}}static{{end}} \
                {{ range .Values.sawtooth.externalSeeds }}{{if ($peering) }}--seeds{{else}}--peers{{end}} tcp://{{.hostname}}:{{.port}} {{end}} \
                {{if ($peering)}}${SEEDS}{{else}}${PEERS}{{end}} \
                --maximum-peer-connectivity 255 \
                {{- if .Values.sawtooth.opentsdb.enabled }}
                --opentsdb-db {{.Values.sawtooth.opentsdb.db}} \
                --opentsdb-url {{.Values.sawtooth.opentsdb.url}} \
                {{- end }}
                ;
              exit_code=$?
              for signal in ${EXIT_SIGNALS}; do
                touch "${SIGNALS_DIR}/$signal"
              done
              exit $exit_code
          volumeMounts:
            - mountPath: /var/run/sawtooth
              name: sawtooth-signals
            - mountPath: "/etc/sawtooth"
              name: sawtooth-etc
            - mountPath: "/var/lib/sawtooth"
              name: sawtooth-data
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          {{if .Values.sawtooth.livenessProbe.enabled }}
          livenessProbe:
            exec:
              command:
              - /bin/bash
              - -c
              - |
                export SIGNALS_DIR=/var/run/sawtooth
                export EXIT_SIGNALS="{{.Values.sawtooth.livenessProbe.exitSignals}}"
                export LIVENESS_PROBE_ACTIVE="{{.Values.sawtooth.livenessProbe.active}}"
                /usr/local/bin/liveness_probe.sh
            initialDelaySeconds: {{.Values.sawtooth.livenessProbe.initialDelaySeconds}}
            periodSeconds: {{.Values.sawtooth.livenessProbe.periodSeconds}}
          {{end}}
          env:
            {{ if .Values.pagerduty.enabled }}
            - name: SERVICE_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.sawtooth.networkName }}-pagerduty
                  key: service_id
            - name: ALERT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.sawtooth.networkName }}-pagerduty
                  key: alert_token
            {{ end }}
            - name: RUST_BACKTRACE
              value: "1"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            {{ range .Values.sawtooth.containers.validator.env }}
            - name: {{.name }}
              value: {{.value | quote }}
            {{end}}
          ports:
            - containerPort: {{.Values.sawtooth.ports.sawcomp}}
              name: sawcomp
            - containerPort: {{.Values.sawtooth.ports.sawnet}}
              hostPort: {{.Values.sawtooth.ports.sawnet}}
              name: sawnet
            - containerPort: {{.Values.sawtooth.ports.consensus}}
              name: consensus
          resources: {{- include "lib.safeToYaml" .Values.sawtooth.containers.validator.resources | nindent 12 }}
      initContainers:
        - name: setup
          image: {{.Values.images.validator}}
          imagePullPolicy: {{.Values.sawtooth.containers.validator.imagePullPolicy}}
          volumeMounts:
            - mountPath: "/etc/sawtooth"
              name: sawtooth-etc
            - mountPath: "/var/lib/sawtooth"
              name: sawtooth-data
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          command: [ "bash", "-c" ]
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          args:
            - |
              if [ -r /etc/sawtooth/genesis.seed ]; then
                OLD_SEED=`cat /etc/sawtooth/genesis.seed`
                if [ "$OLD_SEED" != "{{.Values.sawtooth.genesis.seed}}" ]; then
                  echo "${OLD_SEED} != ${{.Values.sawtooth.genesis.seed}} -- resetting environment"
                  rm -rf /var/lib/sawtooth/*
                  rm -f /etc/sawtooth/genesis/*
                  rm -f /etc/sawtooth/initialized
                  echo {{.Values.sawtooth.genesis.seed}} > /etc/sawtooth/genesis.seed
                fi
              else
                  echo "Resetting environment and setting Genesis Seed to {{.Values.sawtooth.genesis.seed}}"
                  rm -rf /var/lib/sawtooth/*
                  rm -f /etc/sawtooth/genesis/*
                  rm -f /etc/sawtooth/initialized
                  echo {{.Values.sawtooth.genesis.seed}} > /etc/sawtooth/genesis.seed
              fi
              mkdir -p /etc/sawtooth/genesis
              mkdir -p /etc/sawtooth/keys
              if [ ! -r /etc/sawtooth/keys/validator.priv ]; then
                sawadm keygen --force
              fi
        {{ if .Values.sawtooth.genesis.enabled }}
          {{ if eq $consensus 200 }}
        - name: poet-registration
          image: {{.Values.images.poet_cli}}
          imagePullPolicy: {{.Values.sawtooth.containers.poet_cli.imagePullPolicy}}
          command: [ "bash", "-c" ]
          args:
          - |
            mkdir -p /sawtooth-etc/poet
            cp /etc/sawtooth/simulator_rk_pub.pem /sawtooth-etc/;
            if [ ! -f /sawtooth-etc/poet/poet-enclave-measurement ]; then
              poet enclave measurement > /sawtooth-etc/poet/poet-enclave-measurement;
            fi
            if [ ! -f /sawtooth-etc/poet/poet-enclave-basename ]; then
              poet enclave basename > /sawtooth-etc/poet/poet-enclave-basename;
            fi
            poet registration create --enclave-module simulator \
                  -k /sawtooth-etc/keys/validator.priv \
                  -o /sawtooth-etc/genesis/200.poet.batch
          volumeMounts:
            - mountPath: "/sawtooth-etc"
              name: sawtooth-etc
            - mountPath: "/var/lib/sawtooth"
              name: sawtooth-data
            {{- include "lib.volumeMounts" .Values.extraVolumeMounts | nindent 12 }}
            {{- include "lib.volumeMounts" .Values.sawtooth.extraVolumeMounts | nindent 12 }}
          {{ end }}
        {{ end }}
      volumes:
        - name: sawtooth-signals
          emptyDir: {}
        - name: sawtooth-etc
          hostPath:
            type: DirectoryOrCreate
            path: {{.Values.sawtooth.volumes.hostPathBaseDir}}/{{.Values.sawtooth.namespace}}/{{.Values.sawtooth.networkName}}/sawtooth-etc
        - name: sawtooth-data
          hostPath:
            type: DirectoryOrCreate
            path: {{.Values.sawtooth.volumes.hostPathBaseDir}}/{{.Values.sawtooth.namespace}}/{{.Values.sawtooth.networkName}}/sawtooth-data
        {{- include "lib.volumes" .Values.extraVolumes | nindent 8 }}
        {{- include "lib.volumes" .Values.sawtooth.extraVolumes | nindent 8 }}
